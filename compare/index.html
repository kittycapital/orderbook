<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>현물 vs 선물 오더북 비교 | Herdvibe</title>
    <meta property="og:title" content="현물 vs 선물 오더북 비교 | Herdvibe">
    <meta property="og:description" content="BTC/ETH/SOL 현물·선물 오더북 비교 — Basis, 유동성, Imbalance 분석">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #555555;
            --border-color: #2a2a2a;
            --bid-color: #00d4aa;
            --ask-color: #ff4757;
            --spot-color: #4dabf7;
            --perp-color: #ffd43b;
            --binance-color: #F0B90B;
            --bybit-color: #F7931A;
            --kraken-color: #7B61FF;
            --hyperliquid-color: #00E5A0;
        }

        html, body { overflow-x: hidden; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px 20px 40px; }

        .header {
            text-align: center; padding: 30px 0 20px;
            border-bottom: 1px solid var(--border-color); margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px;
            background: linear-gradient(135deg, #fff 0%, #888 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .header p { color: var(--text-secondary); font-size: 0.85rem; }

        /* Controls */
        .controls {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; flex-wrap: wrap; margin-bottom: 20px;
        }

        .control-group { display: flex; align-items: center; gap: 6px; }
        .control-label { font-size: 0.72rem; color: var(--text-secondary); }

        .ctrl-btn {
            font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
            padding: 6px 12px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
        }

        .ctrl-btn:hover { border-color: #3a3a3a; }
        .ctrl-btn.active { border-color: var(--bid-color); color: var(--bid-color); background: rgba(0,212,170,0.1); }
        .ctrl-btn.coin-active { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

        .refresh-btn {
            font-family: 'Noto Sans KR', sans-serif; font-size: 0.72rem;
            padding: 6px 14px; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); border-radius: 6px;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 5px;
        }

        .refresh-btn:hover { border-color: var(--bid-color); color: var(--bid-color); }
        .refresh-btn.loading { opacity: 0.5; pointer-events: none; }
        .refresh-btn svg { width: 13px; height: 13px; }

        .auto-toggle {
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
            padding: 4px 8px; background: transparent;
            border: 1px solid var(--border-color); border-radius: 4px;
            color: var(--text-muted); cursor: pointer; transition: all 0.2s;
        }

        .auto-toggle.on { border-color: var(--bid-color); color: var(--bid-color); }

        /* Section */
        .section {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }

        .section-header { text-align: center; margin-bottom: 15px; }
        .section-title { font-size: 1.1rem; font-weight: 600; }
        .section-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

        /* Basis Cards */
        .basis-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }

        .basis-card {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 16px; text-align: center;
        }

        .bc-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .bc-value { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 600; }
        .bc-sub { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; }

        /* Dual chart */
        .dual-charts {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }

        .chart-panel {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 15px;
        }

        .chart-panel-title {
            text-align: center; font-size: 0.85rem; font-weight: 600; margin-bottom: 10px;
        }

        .chart-container { position: relative; height: 300px; width: 100%; }

        /* Imbalance */
        .imbalance-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }

        .imbalance-card {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 16px;
        }

        .imb-title { text-align: center; font-size: 0.8rem; font-weight: 600; margin-bottom: 12px; }

        .imb-bar-wrap { position: relative; height: 24px; border-radius: 12px; overflow: hidden; background: var(--bg-primary); margin-bottom: 8px; }
        .imb-bar-bid { position: absolute; left: 0; top: 0; height: 100%; background: var(--bid-color); border-radius: 12px 0 0 12px; transition: width 0.4s; }
        .imb-bar-ask { position: absolute; right: 0; top: 0; height: 100%; background: var(--ask-color); border-radius: 0 12px 12px 0; transition: width 0.4s; }

        .imb-labels {
            display: flex; justify-content: space-between;
            font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
        }

        .imb-labels .bid-lbl { color: var(--bid-color); }
        .imb-labels .ask-lbl { color: var(--ask-color); }

        /* Liquidity compare */
        .liq-compare {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center;
        }

        .liq-box {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 16px; text-align: center;
        }

        .liq-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }
        .liq-val { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 600; }
        .liq-sub { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; }

        .liq-ratio {
            text-align: center; padding: 10px;
        }

        .liq-ratio .ratio-num {
            font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 700;
            color: var(--perp-color);
        }

        .liq-ratio .ratio-label { font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; }

        /* Market Signal */
        .signal-box {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 20px; text-align: center;
        }

        .signal-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .signal-text {
            font-size: 0.9rem; font-weight: 500; line-height: 1.6;
            max-width: 600px; margin: 0 auto;
        }

        .signal-tag {
            display: inline-block; padding: 4px 12px; border-radius: 20px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
            font-weight: 600; margin-top: 10px;
        }

        .signal-tag.bullish { background: rgba(0,212,170,0.15); color: var(--bid-color); border: 1px solid rgba(0,212,170,0.3); }
        .signal-tag.bearish { background: rgba(255,71,87,0.15); color: var(--ask-color); border: 1px solid rgba(255,71,87,0.3); }
        .signal-tag.neutral { background: rgba(136,136,136,0.15); color: var(--text-secondary); border: 1px solid rgba(136,136,136,0.3); }

        /* Share */
        .share-bar { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }

        .share-btn {
            display: flex; align-items: center; gap: 6px; padding: 8px 14px;
            background: transparent; border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-secondary); font-size: 0.72rem;
            font-family: 'Noto Sans KR', sans-serif; cursor: pointer; transition: all 0.2s;
        }

        .share-btn svg { width: 14px; height: 14px; }
        .share-btn:hover { background: var(--bg-tertiary); }
        .share-btn.twitter:hover { border-color: #1da1f2; color: #1da1f2; }
        .share-btn.kakao:hover { border-color: #fee500; color: #fee500; }
        .share-btn.telegram:hover { border-color: #26a5e4; color: #26a5e4; }
        .share-btn.instagram:hover { border-color: #E4405F; color: #E4405F; }
        .share-btn.copy-link:hover { border-color: var(--bid-color); color: var(--bid-color); }

        .footer {
            text-align: center; padding: 15px 0; border-top: 1px solid var(--border-color);
            font-size: 0.7rem; color: var(--text-muted); line-height: 1.8;
        }
        .footer a { color: var(--bid-color); text-decoration: none; }

        .updated-time { text-align: center; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 15px; font-family: 'JetBrains Mono', monospace; }

        @media (max-width: 768px) {
            .container { padding: 10px 12px 30px; }
            .header h1 { font-size: 1.3rem; }
            .dual-charts { grid-template-columns: 1fr; }
            .imbalance-row { grid-template-columns: 1fr; }
            .liq-compare { grid-template-columns: 1fr; }
            .chart-container { height: 250px; }
        }

        @media (max-width: 480px) {
            .chart-container { height: 200px; }
            .basis-cards { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>현물 vs 선물 오더북 비교</h1>
            <p>Basis · 유동성 · Imbalance 실시간 분석</p>
        </header>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <span class="control-label">코인:</span>
                <button class="ctrl-btn coin-active" data-coin="BTC">BTC</button>
                <button class="ctrl-btn" data-coin="ETH">ETH</button>
                <button class="ctrl-btn" data-coin="SOL">SOL</button>
            </div>
            <div class="control-group">
                <span class="control-label">범위:</span>
                <button class="ctrl-btn" data-range="1">±1%</button>
                <button class="ctrl-btn active" data-range="2">±2%</button>
                <button class="ctrl-btn" data-range="5">±5%</button>
                <button class="ctrl-btn" data-range="10">±10%</button>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="fetchAll()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                Refresh
            </button>
            <div class="control-group">
                <span class="control-label">자동:</span>
                <button class="auto-toggle on" data-interval="0" id="autoOff">OFF</button>
                <button class="auto-toggle" data-interval="5">5s</button>
                <button class="auto-toggle" data-interval="10">10s</button>
                <button class="auto-toggle" data-interval="30">30s</button>
            </div>
        </div>

        <div class="updated-time" id="updatedTime">데이터 로딩 중...</div>

        <!-- Basis Cards -->
        <div class="basis-cards">
            <div class="basis-card">
                <div class="bc-label">Spot Mid</div>
                <div class="bc-value" style="color:var(--spot-color)" id="spotMid">-</div>
                <div class="bc-sub">현물 중간가</div>
            </div>
            <div class="basis-card">
                <div class="bc-label">Perp Mid</div>
                <div class="bc-value" style="color:var(--perp-color)" id="perpMid">-</div>
                <div class="bc-sub">선물 중간가</div>
            </div>
            <div class="basis-card">
                <div class="bc-label">Basis</div>
                <div class="bc-value" id="basisValue">-</div>
                <div class="bc-sub" id="basisLabel">-</div>
            </div>
            <div class="basis-card">
                <div class="bc-label">Basis %</div>
                <div class="bc-value" id="basisPct">-</div>
                <div class="bc-sub" id="basisType">-</div>
            </div>
        </div>

        <!-- Dual Depth Charts -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Depth Chart 비교</h2>
                <p class="section-desc">좌: 현물 · 우: 선물 — 동일 가격 범위</p>
            </div>
            <div class="dual-charts">
                <div class="chart-panel">
                    <div class="chart-panel-title" style="color:var(--spot-color)">Spot</div>
                    <div class="chart-container"><canvas id="spotChart"></canvas></div>
                </div>
                <div class="chart-panel">
                    <div class="chart-panel-title" style="color:var(--perp-color)">Perp</div>
                    <div class="chart-container"><canvas id="perpChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- Imbalance -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Bid-Ask Imbalance</h2>
                <p class="section-desc">매수/매도 물량 비율 — 50% 이상이 우위</p>
            </div>
            <div class="imbalance-row">
                <div class="imbalance-card">
                    <div class="imb-title" style="color:var(--spot-color)">Spot</div>
                    <div class="imb-bar-wrap">
                        <div class="imb-bar-bid" id="spotBidBar"></div>
                        <div class="imb-bar-ask" id="spotAskBar"></div>
                    </div>
                    <div class="imb-labels">
                        <span class="bid-lbl" id="spotBidPct">Bid -</span>
                        <span class="ask-lbl" id="spotAskPct">Ask -</span>
                    </div>
                </div>
                <div class="imbalance-card">
                    <div class="imb-title" style="color:var(--perp-color)">Perp</div>
                    <div class="imb-bar-wrap">
                        <div class="imb-bar-bid" id="perpBidBar"></div>
                        <div class="imb-bar-ask" id="perpAskBar"></div>
                    </div>
                    <div class="imb-labels">
                        <span class="bid-lbl" id="perpBidPct">Bid -</span>
                        <span class="ask-lbl" id="perpAskPct">Ask -</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Liquidity Compare -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">유동성 비교</h2>
                <p class="section-desc">범위 내 총 물량 (Bid + Ask)</p>
            </div>
            <div class="liq-compare">
                <div class="liq-box">
                    <div class="liq-label">Spot</div>
                    <div class="liq-val" style="color:var(--spot-color)" id="spotTotalVol">-</div>
                    <div class="liq-sub" id="spotTotalUsd">-</div>
                </div>
                <div class="liq-ratio">
                    <div class="ratio-num" id="liqRatio">-</div>
                    <div class="ratio-label">Perp / Spot</div>
                </div>
                <div class="liq-box">
                    <div class="liq-label">Perp</div>
                    <div class="liq-val" style="color:var(--perp-color)" id="perpTotalVol">-</div>
                    <div class="liq-sub" id="perpTotalUsd">-</div>
                </div>
            </div>
        </section>

        <!-- Market Signal -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">시장 해석</h2>
                <p class="section-desc">오더북 데이터 기반 자동 분석</p>
            </div>
            <div class="signal-box" id="signalBox">
                <div class="signal-text" id="signalText">데이터를 불러오는 중입니다...</div>
            </div>
        </section>

        <!-- Share -->
        <div class="share-bar">
            <button class="share-btn twitter" onclick="shareTwitter()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                트위터
            </button>
            <button class="share-btn kakao" onclick="shareKakao()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.477 3 2 6.463 2 10.691c0 2.724 1.8 5.116 4.508 6.482-.144.525-.925 3.388-.958 3.603 0 0-.02.157.083.217.103.06.224.013.224.013.296-.041 3.434-2.263 3.973-2.652.703.098 1.428.15 2.17.15 5.523 0 10-3.463 10-7.813C22 6.463 17.523 3 12 3z"/></svg>
                카카오톡
            </button>
            <button class="share-btn telegram" onclick="shareTelegram()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                텔레그램
            </button>
            <button class="share-btn instagram" onclick="shareInstagram()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                인스타그램
            </button>
            <button class="share-btn copy-link" onclick="copyLink()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                링크 복사
            </button>
        </div>

        <footer class="footer">
            현물 vs 선물 오더북 비교 분석<br>
            실시간 데이터 · API Key 불필요<br>
            <a href="https://herdvibe.com" target="_blank">herdvibe.com</a>
        </footer>
    </div>

    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js" crossorigin="anonymous"></script>

    <script>
        const KAKAO_KEY = 'a43ed7b39fac35458f4f9df925a279b5';
        const SHARE_URL = 'https://herdvibe.com/88';

        const SPOT_SYMBOLS = {
            BTC: { binance: 'BTCUSDT', bybit: 'BTCUSDT', kraken: 'XBTUSD' },
            ETH: { binance: 'ETHUSDT', bybit: 'ETHUSDT', kraken: 'ETHUSD' },
            SOL: { binance: 'SOLUSDT', bybit: 'SOLUSDT', kraken: 'SOLUSD' },
        };

        const PERP_SYMBOLS = {
            BTC: { binance: 'BTCUSDT', bybit: 'BTCUSDT', kraken: 'PF_XBTUSD', hyperliquid: 'BTC' },
            ETH: { binance: 'ETHUSDT', bybit: 'ETHUSDT', kraken: 'PF_ETHUSD', hyperliquid: 'ETH' },
            SOL: { binance: 'SOLUSDT', bybit: 'SOLUSDT', kraken: 'PF_SOLUSD', hyperliquid: 'SOL' },
        };

        let currentCoin = 'BTC';
        let currentRange = 2;
        let autoInterval = 0;
        let autoTimer = null;
        let spotChart = null;
        let perpChart = null;
        let spotBooks = {};
        let perpBooks = {};

        // ============================================================
        // FETCHERS
        // ============================================================
        async function fetchSpotBinance(coin) {
            const r = await fetch(`https://api.binance.com/api/v3/depth?symbol=${SPOT_SYMBOLS[coin].binance}&limit=1000`);
            const d = await r.json();
            return { bids: d.bids.map(([p,q])=>[+p,+q]), asks: d.asks.map(([p,q])=>[+p,+q]) };
        }
        async function fetchSpotBybit(coin) {
            const r = await fetch(`https://api.bybit.com/v5/market/orderbook?category=spot&symbol=${SPOT_SYMBOLS[coin].bybit}&limit=200`);
            const d = await r.json();
            return { bids: d.result.b.map(([p,q])=>[+p,+q]), asks: d.result.a.map(([p,q])=>[+p,+q]) };
        }
        async function fetchSpotKraken(coin) {
            const r = await fetch(`https://api.kraken.com/0/public/Depth?pair=${SPOT_SYMBOLS[coin].kraken}&count=500`);
            const d = await r.json();
            const k = Object.keys(d.result)[0];
            return { bids: d.result[k].bids.map(([p,q])=>[+p,+q]), asks: d.result[k].asks.map(([p,q])=>[+p,+q]) };
        }
        async function fetchPerpBinance(coin) {
            const r = await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${PERP_SYMBOLS[coin].binance}&limit=1000`);
            const d = await r.json();
            return { bids: d.bids.map(([p,q])=>[+p,+q]), asks: d.asks.map(([p,q])=>[+p,+q]) };
        }
        async function fetchPerpBybit(coin) {
            const r = await fetch(`https://api.bybit.com/v5/market/orderbook?category=linear&symbol=${PERP_SYMBOLS[coin].bybit}&limit=200`);
            const d = await r.json();
            return { bids: d.result.b.map(([p,q])=>[+p,+q]), asks: d.result.a.map(([p,q])=>[+p,+q]) };
        }
        async function fetchPerpKraken(coin) {
            const r = await fetch(`https://futures.kraken.com/derivatives/api/v3/orderbook?symbol=${PERP_SYMBOLS[coin].kraken}`);
            const d = await r.json();
            return { bids: d.orderBook.bids.map(([p,q])=>[+p,+q]), asks: d.orderBook.asks.map(([p,q])=>[+p,+q]) };
        }
        async function fetchPerpHyperliquid(coin) {
            const r = await fetch('https://api.hyperliquid.xyz/info', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({type:'l2Book',coin:PERP_SYMBOLS[coin].hyperliquid})
            });
            const d = await r.json();
            return { bids: d.levels[0].map(({px,sz})=>[+px,+sz]), asks: d.levels[1].map(({px,sz})=>[+px,+sz]) };
        }

        // ============================================================
        // MERGE BOOKS
        // ============================================================
        function mergeBooks(books) {
            let allBids = [], allAsks = [];
            Object.values(books).forEach(({bids, asks}) => {
                allBids.push(...bids);
                allAsks.push(...asks);
            });
            allBids.sort((a,b) => b[0]-a[0]);
            allAsks.sort((a,b) => a[0]-b[0]);
            return { bids: allBids, asks: allAsks };
        }

        function getMid(books) {
            const m = mergeBooks(books);
            if (!m.bids.length || !m.asks.length) return 0;
            return (m.bids[0][0] + m.asks[0][0]) / 2;
        }

        // ============================================================
        // FETCH ALL
        // ============================================================
        async function fetchAll() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');
            spotBooks = {};
            perpBooks = {};

            const safeFetch = async (fn, label) => {
                try { return await fn(currentCoin); } catch(e) { console.error(label, e); return null; }
            };

            const [sb, sy, sk, pb, py, pk, ph] = await Promise.all([
                safeFetch(fetchSpotBinance, 'spot-binance'),
                safeFetch(fetchSpotBybit, 'spot-bybit'),
                safeFetch(fetchSpotKraken, 'spot-kraken'),
                safeFetch(fetchPerpBinance, 'perp-binance'),
                safeFetch(fetchPerpBybit, 'perp-bybit'),
                safeFetch(fetchPerpKraken, 'perp-kraken'),
                safeFetch(fetchPerpHyperliquid, 'perp-hyperliquid'),
            ]);

            if (sb) spotBooks.binance = sb;
            if (sy) spotBooks.bybit = sy;
            if (sk) spotBooks.kraken = sk;
            if (pb) perpBooks.binance = pb;
            if (py) perpBooks.bybit = py;
            if (pk) perpBooks.kraken = pk;
            if (ph) perpBooks.hyperliquid = ph;

            btn.classList.remove('loading');

            if (Object.keys(spotBooks).length > 0 || Object.keys(perpBooks).length > 0) {
                renderAll();
            }
        }

        // ============================================================
        // CUMULATIVE DEPTH
        // ============================================================
        function calcCumulative(books, midPrice, rangePct) {
            const merged = mergeBooks(books);
            const priceMin = midPrice * (1 - rangePct);
            const priceMax = midPrice * (1 + rangePct);
            const GRID = 150;
            const step = (priceMax - priceMin) / GRID;
            const grid = Array.from({length: GRID+1}, (_,i) => priceMin + i*step);

            const bidCum = [], askCum = [];
            grid.forEach(price => {
                if (price <= midPrice) {
                    let vol = 0;
                    for (const [p,q] of merged.bids) { if (p >= price && p <= midPrice) vol += q; }
                    bidCum.push(vol);
                    askCum.push(null);
                } else {
                    let vol = 0;
                    for (const [p,q] of merged.asks) { if (p <= price && p >= midPrice) vol += q; }
                    bidCum.push(null);
                    askCum.push(vol);
                }
            });

            return { grid, bidCum, askCum };
        }

        function getPriceDecimals() {
            if (currentCoin === 'BTC') return 0;
            if (currentCoin === 'ETH') return 1;
            return 3;
        }

        // ============================================================
        // WATERMARK
        // ============================================================
        const watermarkPlugin = {
            id: 'watermark',
            afterDraw(chart) {
                const { ctx, chartArea } = chart;
                if (!chartArea) return;
                ctx.save();
                ctx.font = '24px JetBrains Mono';
                ctx.fillStyle = 'rgba(255,255,255,0.06)';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Herdvibe.com', (chartArea.left+chartArea.right)/2, (chartArea.top+chartArea.bottom)/2);
                ctx.restore();
            }
        };

        // ============================================================
        // RENDER ALL
        // ============================================================
        function renderAll() {
            const spotMid = getMid(spotBooks);
            const perpMid = getMid(perpBooks);
            const mid = spotMid || perpMid;
            const rangePct = currentRange / 100;
            const dec = getPriceDecimals();

            // Basis
            const basis = perpMid - spotMid;
            const basisPct = spotMid > 0 ? (basis / spotMid * 100) : 0;

            document.getElementById('spotMid').textContent = spotMid > 0 ? '$' + spotMid.toLocaleString('en-US', {maximumFractionDigits: dec}) : '-';
            document.getElementById('perpMid').textContent = perpMid > 0 ? '$' + perpMid.toLocaleString('en-US', {maximumFractionDigits: dec}) : '-';

            const bvEl = document.getElementById('basisValue');
            bvEl.textContent = (basis >= 0 ? '+$' : '-$') + Math.abs(basis).toFixed(dec);
            bvEl.style.color = basis >= 0 ? 'var(--bid-color)' : 'var(--ask-color)';
            document.getElementById('basisLabel').textContent = basis >= 0 ? '선물 프리미엄' : '선물 디스카운트';

            const bpEl = document.getElementById('basisPct');
            bpEl.textContent = (basisPct >= 0 ? '+' : '') + basisPct.toFixed(4) + '%';
            bpEl.style.color = basisPct >= 0 ? 'var(--bid-color)' : 'var(--ask-color)';
            document.getElementById('basisType').textContent = basisPct >= 0 ? 'Contango' : 'Backwardation';

            // Charts
            renderDepthChart('spotChart', spotBooks, spotMid || mid, rangePct, 'var(--spot-color)', 'rgba(77,171,247,0.2)', 'spotChartRef');
            renderDepthChart('perpChart', perpBooks, perpMid || mid, rangePct, 'var(--perp-color)', 'rgba(255,212,59,0.2)', 'perpChartRef');

            // Imbalance
            renderImbalance(spotBooks, spotMid, rangePct, 'spot');
            renderImbalance(perpBooks, perpMid, rangePct, 'perp');

            // Liquidity
            renderLiquidity(spotBooks, perpBooks, spotMid, perpMid, rangePct);

            // Signal
            renderSignal(basis, basisPct, spotBooks, perpBooks, spotMid, perpMid, rangePct);

            document.getElementById('updatedTime').textContent = '업데이트: ' + new Date().toLocaleTimeString('ko-KR');
        }

        // ============================================================
        // DEPTH CHART
        // ============================================================
        function renderDepthChart(canvasId, books, midPrice, rangePct, lineColor, fillColor, refName) {
            const {grid, bidCum, askCum} = calcCumulative(books, midPrice, rangePct);
            const labels = grid.map(p => p.toFixed(getPriceDecimals()));
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (window[refName]) window[refName].destroy();

            window[refName] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label:'Bid', data:bidCum, borderColor:'#00d4aa', backgroundColor:'rgba(0,212,170,0.15)', borderWidth:1.5, fill:true, stepped:'before', pointRadius:0 },
                        { label:'Ask', data:askCum, borderColor:'#ff4757', backgroundColor:'rgba(255,71,87,0.15)', borderWidth:1.5, fill:true, stepped:'after', pointRadius:0 },
                    ]
                },
                plugins: [watermarkPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode:'index', intersect:false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor:'rgba(15,15,15,0.95)',
                            bodyFont:{family:'JetBrains Mono',size:11},
                            callbacks: {
                                title: (i) => '$'+i[0].label,
                                label: (c) => c.raw === null ? null : ` ${c.dataset.label}: ${c.raw.toFixed(4)} ${currentCoin}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid:{color:'rgba(255,255,255,0.04)'},
                            ticks:{color:'#bbb',font:{family:'JetBrains Mono',size:9},autoSkip:true,maxTicksLimit:6,maxRotation:0,callback:function(v){return '$'+this.getLabelForValue(v);}}
                        },
                        y: {
                            grid:{color:'rgba(255,255,255,0.04)'},
                            ticks:{color:'#bbb',font:{family:'JetBrains Mono',size:9},callback:(v)=>v>=1000?(v/1000).toFixed(1)+'K':v.toFixed(1)}
                        }
                    }
                }
            });
        }

        // ============================================================
        // IMBALANCE
        // ============================================================
        function renderImbalance(books, midPrice, rangePct, prefix) {
            let bidVol = 0, askVol = 0;
            Object.values(books).forEach(({bids,asks}) => {
                bids.forEach(([p,q]) => { if (p >= midPrice*(1-rangePct)) bidVol += q; });
                asks.forEach(([p,q]) => { if (p <= midPrice*(1+rangePct)) askVol += q; });
            });

            const total = bidVol + askVol;
            const bidPct = total > 0 ? (bidVol/total*100) : 50;
            const askPct = total > 0 ? (askVol/total*100) : 50;

            document.getElementById(prefix+'BidBar').style.width = bidPct + '%';
            document.getElementById(prefix+'AskBar').style.width = askPct + '%';
            document.getElementById(prefix+'BidPct').textContent = `Bid ${bidPct.toFixed(1)}%`;
            document.getElementById(prefix+'AskPct').textContent = `Ask ${askPct.toFixed(1)}%`;
        }

        // ============================================================
        // LIQUIDITY
        // ============================================================
        function renderLiquidity(sBooks, pBooks, sMid, pMid, rangePct) {
            let sVol = 0, pVol = 0;
            Object.values(sBooks).forEach(({bids,asks}) => {
                bids.forEach(([p,q]) => { if (p >= sMid*(1-rangePct)) sVol += q; });
                asks.forEach(([p,q]) => { if (p <= sMid*(1+rangePct)) sVol += q; });
            });
            Object.values(pBooks).forEach(({bids,asks}) => {
                bids.forEach(([p,q]) => { if (p >= pMid*(1-rangePct)) pVol += q; });
                asks.forEach(([p,q]) => { if (p <= pMid*(1+rangePct)) pVol += q; });
            });

            document.getElementById('spotTotalVol').textContent = sVol.toFixed(2) + ' ' + currentCoin;
            document.getElementById('perpTotalVol').textContent = pVol.toFixed(2) + ' ' + currentCoin;
            document.getElementById('spotTotalUsd').textContent = '$' + (sVol * sMid).toLocaleString('en-US', {maximumFractionDigits:0});
            document.getElementById('perpTotalUsd').textContent = '$' + (pVol * pMid).toLocaleString('en-US', {maximumFractionDigits:0});

            const ratio = sVol > 0 ? (pVol / sVol).toFixed(1) : '-';
            document.getElementById('liqRatio').textContent = ratio + 'x';
        }

        // ============================================================
        // SIGNAL
        // ============================================================
        function renderSignal(basis, basisPct, sBooks, pBooks, sMid, pMid, rangePct) {
            // Spot imbalance
            let sBid=0, sAsk=0, pBid=0, pAsk=0;
            Object.values(sBooks).forEach(({bids,asks}) => {
                bids.forEach(([p,q]) => { if (p >= sMid*(1-rangePct)) sBid += q; });
                asks.forEach(([p,q]) => { if (p <= sMid*(1+rangePct)) sAsk += q; });
            });
            Object.values(pBooks).forEach(({bids,asks}) => {
                bids.forEach(([p,q]) => { if (p >= pMid*(1-rangePct)) pBid += q; });
                asks.forEach(([p,q]) => { if (p <= pMid*(1+rangePct)) pAsk += q; });
            });

            const sTotal = sBid+sAsk, pTotal = pBid+pAsk;
            const sBidPct = sTotal > 0 ? sBid/sTotal*100 : 50;
            const pBidPct = pTotal > 0 ? pBid/pTotal*100 : 50;
            const perpSpotRatio = sTotal > 0 ? pTotal/sTotal : 1;

            let signals = [];
            let score = 0; // positive=bullish, negative=bearish

            // Basis signal
            if (basisPct > 0.05) { signals.push(`선물 프리미엄 +${basisPct.toFixed(3)}% (콘탱고)`); score += 1; }
            else if (basisPct < -0.05) { signals.push(`선물 디스카운트 ${basisPct.toFixed(3)}% (백워데이션)`); score -= 1; }
            else { signals.push(`Basis 중립 (${basisPct.toFixed(3)}%)`); }

            // Spot imbalance
            if (sBidPct > 55) { signals.push(`현물 매수벽 우위 (${sBidPct.toFixed(0)}%)`); score += 1; }
            else if (sBidPct < 45) { signals.push(`현물 매도벽 우위 (${(100-sBidPct).toFixed(0)}%)`); score -= 1; }
            else { signals.push(`현물 Bid-Ask 균형`); }

            // Perp imbalance
            if (pBidPct > 55) { signals.push(`선물 매수벽 우위 (${pBidPct.toFixed(0)}%)`); score += 1; }
            else if (pBidPct < 45) { signals.push(`선물 매도벽 우위 (${(100-pBidPct).toFixed(0)}%)`); score -= 1; }
            else { signals.push(`선물 Bid-Ask 균형`); }

            // Leverage ratio
            if (perpSpotRatio > 5) { signals.push(`선물/현물 유동성 비율 ${perpSpotRatio.toFixed(1)}x — 레버리지 투기 중심`); }
            else if (perpSpotRatio < 2) { signals.push(`선물/현물 유동성 비율 ${perpSpotRatio.toFixed(1)}x — 현물 수요 기반`); }

            let tag, tagClass;
            if (score >= 2) { tag = 'BULLISH'; tagClass = 'bullish'; }
            else if (score <= -2) { tag = 'BEARISH'; tagClass = 'bearish'; }
            else if (score > 0) { tag = 'SLIGHTLY BULLISH'; tagClass = 'bullish'; }
            else if (score < 0) { tag = 'SLIGHTLY BEARISH'; tagClass = 'bearish'; }
            else { tag = 'NEUTRAL'; tagClass = 'neutral'; }

            const box = document.getElementById('signalBox');
            box.innerHTML = `
                <div class="signal-text">${signals.join('<br>')}</div>
                <div class="signal-tag ${tagClass}">${tag}</div>
            `;
        }

        // ============================================================
        // CONTROLS
        // ============================================================
        document.querySelectorAll('[data-coin]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-coin]').forEach(b => b.classList.remove('coin-active'));
                btn.classList.add('coin-active');
                currentCoin = btn.dataset.coin;
                fetchAll();
            });
        });

        document.querySelectorAll('[data-range]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-range]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRange = parseInt(btn.dataset.range);
                if (Object.keys(spotBooks).length > 0) renderAll();
            });
        });

        document.querySelectorAll('.auto-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.auto-toggle').forEach(b => b.classList.remove('on'));
                btn.classList.add('on');
                autoInterval = parseInt(btn.dataset.interval);
                if (autoTimer) clearInterval(autoTimer);
                if (autoInterval > 0) autoTimer = setInterval(fetchAll, autoInterval * 1000);
            });
        });

        // ============================================================
        // SHARING
        // ============================================================
        function shareTwitter() {
            const text = `${currentCoin} 현물 vs 선물 오더북 비교\nBasis, 유동성, Imbalance 실시간 분석`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(SHARE_URL)}`, '_blank');
        }
        function shareKakao() {
            if (!Kakao.isInitialized()) Kakao.init(KAKAO_KEY);
            Kakao.Share.sendDefault({
                objectType:'feed',
                content:{title:`${currentCoin} 현물 vs 선물 비교`,description:'오더북 기반 시장 분석',imageUrl:'',link:{mobileWebUrl:SHARE_URL,webUrl:SHARE_URL}},
                buttons:[{title:'차트 보기',link:{mobileWebUrl:SHARE_URL,webUrl:SHARE_URL}}]
            });
        }
        function shareTelegram() {
            window.open(`https://t.me/share/url?url=${encodeURIComponent(SHARE_URL)}&text=${encodeURIComponent(`${currentCoin} 현물 vs 선물 오더북 비교`)}`, '_blank');
        }
        function clipCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); } catch(e) {}
            document.body.removeChild(ta);
            return Promise.resolve();
        }
        function shareInstagram() {
            clipCopy(SHARE_URL).then(() => {
                const btn = document.querySelector('.instagram');
                const orig = btn.innerHTML;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> 링크 복사됨! 스토리에 붙여넣기';
                btn.style.borderColor = '#E4405F'; btn.style.color = '#E4405F';
                setTimeout(() => { btn.innerHTML = orig; btn.style.borderColor = ''; btn.style.color = ''; }, 2500);
            });
        }
        function copyLink() {
            clipCopy(SHARE_URL).then(() => {
                const btn = document.querySelector('.copy-link');
                const orig = btn.innerHTML;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> 복사됨!';
                btn.style.borderColor = 'var(--bid-color)'; btn.style.color = 'var(--bid-color)';
                setTimeout(() => { btn.innerHTML = orig; btn.style.borderColor = ''; btn.style.color = ''; }, 2000);
            });
        }

        // ============================================================
        // BOOT
        // ============================================================
        document.addEventListener('DOMContentLoaded', fetchAll);
    </script>
</body>
</html>
